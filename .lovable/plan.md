

# Fix: Make the Email Template Editor Reliable Once and For All

## Root Cause Analysis

After tracing through the entire flow, I found **one fundamental bug** that explains all the unreliability, plus several secondary issues:

### The Core Bug: `parseHtmlToData` Doesn't Parse Text Content

The `parseHtmlToData` function (line 304 in `VisualEmailEditor.tsx`) only detects toggle states (showHeadshot, showEventDetails, etc.) and colors. It **completely ignores** the heading and paragraph text.

So here's what happens every time:
1. You customize the heading to "Join Samir's Event!" and write custom body paragraphs
2. You save -- the full HTML is correctly stored in the database
3. The save triggers a re-fetch of templates, which updates `existingTemplate`
4. The `key` prop changes (because `existingTemplate.id` is now available), causing VisualEmailEditor to fully remount
5. On remount, `parseHtmlToData` is called but only extracts toggles -- not your heading or paragraphs
6. The heading resets to the default ("RSVP Confirmed!" or whatever), paragraphs reset to defaults
7. The `useEffect` that generates HTML fires (after the initial mount skip), overwriting the saved HTML with the default-text version

Your custom text is lost on every save/reload cycle.

### Secondary Issues

1. **The `useEffect` on line 72 of `EmailTemplateEditor.tsx` re-runs too aggressively.** It watches `existingTemplate` and `globalTemplate` as dependencies, which are new object references on every render (from `templates.find()`). This causes the `htmlContent` state to reset unpredictably.

2. **No `invitation` entry in the VisualEmailEditor defaults.** The `DEFAULT_HEADINGS` and `DEFAULT_PARAGRAPHS` objects don't have an `invitation` key, so invitation templates get generic fallback text.

3. **The `isInitialMount` ref resets to `true` in the emailType change handler (line 100)**, which is correct for switching types but creates a window where the next data change won't trigger `onHtmlChange`.

## The Fix

### 1. `src/components/events/email/VisualEmailEditor.tsx` -- Parse heading and paragraphs from saved HTML

Update `parseHtmlToData` to extract the actual heading text and body paragraphs from the saved HTML. The HTML structure is predictable (generated by `dataToHtml`), so we can reliably parse:

- **Heading**: Extract text from the `<h1>` tag
- **Paragraphs**: Extract text from the `<p>` tags in the main content section (between the `<h1>` and the Event Details card or Host Info section)

```
function parseHtmlToData(html: string): Partial<VisualEditorData> {
  const result: Partial<VisualEditorData> = {}

  // ... existing toggle parsing (showEventDetails, showHeadshot, etc.) stays the same ...

  // Extract heading from <h1> tag
  const headingMatch = html.match(/<h1[^>]*>(.*?)<\/h1>/s)
  if (headingMatch) {
    result.heading = headingMatch[1].replace(/<[^>]*>/g, '').trim()
  }

  // Extract body paragraphs from main content
  // These are <p> tags after the <h1> and before Event Details or Host Info
  const mainContentMatch = html.match(/<\/h1>([\s\S]*?)(?:<!-- Event Details|Hosted by|<\/td>\s*<\/tr>\s*<!-- Footer)/i)
  if (mainContentMatch) {
    const paragraphs = [...mainContentMatch[1].matchAll(/<p[^>]*>(.*?)<\/p>/gs)]
      .map(m => m[1].replace(/<[^>]*>/g, '').trim())
      .filter(p => p.length > 0)
    if (paragraphs.length > 0) {
      result.paragraphs = paragraphs
    }
  }

  // ... existing color parsing stays the same ...

  return result
}
```

### 2. `src/components/events/email/VisualEmailEditor.tsx` -- Add invitation defaults

Add entries for `invitation` in `DEFAULT_HEADINGS` and `DEFAULT_PARAGRAPHS`:

```
// In DEFAULT_HEADINGS
invitation: "You're Invited! ✉️"

// In DEFAULT_PARAGRAPHS
invitation: [
  'Hi there,',
  '{agent_name} would love for you to join us for {event_title}!',
  'Click the link below to RSVP and reserve your spot.',
]
```

### 3. `src/components/events/email/EmailTemplateEditor.tsx` -- Stabilize the useEffect dependencies

The useEffect on line 72 that sets `htmlContent` based on the template source has `existingTemplate` and `globalTemplate` as dependencies. These are derived from `templates.find()` which returns a new reference on every render, causing unnecessary re-runs.

Fix: Compare by ID instead of object reference, using a separate state to track the loaded template ID.

```
const existingTemplateId = existingTemplate?.id
const globalTemplateId = globalTemplate?.id

useEffect(() => {
  if (existingTemplate) {
    setSubject(existingTemplate.subject)
    setHtmlContent(existingTemplate.html_content)
    setTextContent(existingTemplate.text_content || '')
    setIsActive(existingTemplate.is_active)
  } else if (globalTemplate) {
    setSubject(globalTemplate.subject)
    setHtmlContent(globalTemplate.html_content)
    setTextContent(globalTemplate.text_content || '')
    setIsActive(true)
  } else if (!templatesLoading && !globalLoading) {
    const defaultTemplate = getDefaultEmailTemplate(emailType)
    setSubject("You're confirmed for {event_title}")
    setHtmlContent(defaultTemplate)
    setTextContent('')
    setIsActive(true)
  }
}, [existingTemplateId, globalTemplateId, emailType, templatesLoading, globalLoading])
```

Key changes:
- Depend on `existingTemplateId` and `globalTemplateId` (stable strings) instead of object references
- Only fall through to defaults after loading has completed (`!templatesLoading && !globalLoading`)

### 4. `src/components/events/email/VisualEmailEditor.tsx` -- Make `showEventDetails` default to `true` for invitation

Update `getDefaultData` so invitation type defaults to showing event details (since an invitation should include date/time/location):

```
showEventDetails: emailType !== 'thank_you' && emailType !== 'no_show',
// This already covers invitation = true, so no change needed here
```

(Already correct -- just confirming.)

## Files Modified

| File | Change |
|---|---|
| `src/components/events/email/VisualEmailEditor.tsx` | Add heading + paragraph parsing to `parseHtmlToData`; add `invitation` defaults to `DEFAULT_HEADINGS` and `DEFAULT_PARAGRAPHS` |
| `src/components/events/email/EmailTemplateEditor.tsx` | Stabilize useEffect dependencies to prevent unwanted resets; guard default fallback behind loading completion |

## What This Fixes

- Custom heading text (e.g., "Join Samir's Event!") persists after save and reload
- Custom body paragraphs persist after save and reload
- Toggle states (Show Event Details, etc.) persist after save and reload (already working from prior fix)
- Colors persist after save and reload (already working from prior fix)
- Switching between email type tabs doesn't corrupt other templates
- The invitation email type works correctly with proper defaults
- No more "phantom resets" from unstable useEffect dependencies

## What Stays the Same

- The loading guard and `key` prop from the previous fix remain in place -- they're still correct and necessary
- The edge function fallback fix for thank_you/no_show remains in place
- The save/fetch/update flow in `useEmailTemplates` is unchanged
- No database changes needed
