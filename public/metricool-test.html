<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metricool Test Wrapper</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
        }
        .container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading Metricool...</p>
        </div>
        <iframe
            id="metricool-iframe"
            class="hidden"
            allowfullscreen
            allow="clipboard-write; clipboard-read; fullscreen; encrypted-media; autoplay; picture-in-picture; camera; microphone; geolocation; payment"
            sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-top-navigation allow-modals allow-downloads allow-pointer-lock allow-popups-to-escape-sandbox"
            referrerpolicy="origin"
            credentialless="false"
        ></iframe>
    </div>

    <script>
        // Get URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const metricoolUrl = urlParams.get('url');

        if (!metricoolUrl) {
            document.getElementById('loading').innerHTML = '<p>Error: No URL provided</p>';
        } else {
            console.log('Loading Metricool URL:', metricoolUrl);

            const iframe = document.getElementById('metricool-iframe');
            const loading = document.getElementById('loading');

            // Override window.top and other iframe detection methods BEFORE setting iframe src
            // This must happen before the iframe loads to prevent detection
            try {
                // Override common iframe detection methods using Object.defineProperty
                // Note: These may fail in strict mode, but we'll try anyway
                if (Object.defineProperty) {
                    try {
                        Object.defineProperty(window, 'top', {
                            get: function() { return window; },
                            configurable: true
                        });
                    } catch (e) {
                        console.log('Could not override window.top:', e);
                    }

                    try {
                        Object.defineProperty(window, 'parent', {
                            get: function() { return window; },
                            configurable: true
                        });
                    } catch (e) {
                        console.log('Could not override window.parent:', e);
                    }

                    try {
                        Object.defineProperty(window, 'frameElement', {
                            get: function() { return null; },
                            configurable: true
                        });
                    } catch (e) {
                        console.log('Could not override window.frameElement:', e);
                    }

                    try {
                        Object.defineProperty(window, 'length', {
                            get: function() { return 0; },
                            configurable: true
                        });
                    } catch (e) {
                        console.log('Could not override window.length:', e);
                    }
                }

                // Also try to override self
                try {
                    Object.defineProperty(window, 'self', {
                        get: function() { return window; },
                        configurable: true
                    });
                } catch (e) {
                    console.log('Could not override window.self:', e);
                }

                console.log('Applied iframe detection bypasses');
            } catch (e) {
                console.log('Could not override iframe detection:', e);
            }

            // Set iframe source with proper attributes for authentication
            // Metricool requires referrerpolicy="origin" for proper authentication
            iframe.setAttribute('referrerpolicy', 'origin');
            iframe.setAttribute('allow', 'clipboard-write; clipboard-read; fullscreen; encrypted-media; autoplay; picture-in-picture; camera; microphone; geolocation; payment');

            // Set the source - this will trigger the load
            iframe.src = metricoolUrl;

            // Handle iframe load
            iframe.onload = function() {
                console.log('Iframe loaded successfully');

                // Wait a moment to see if it's actually loaded or if it's a 401 page
                setTimeout(function() {
                    loading.classList.add('hidden');
                    iframe.classList.remove('hidden');
                }, 500);

                try {
                    // Try to communicate with the iframe
                    const iframeWindow = iframe.contentWindow;
                    if (iframeWindow) {
                        console.log('Iframe window accessible');

                        // Send message to iframe to indicate it's not in a frame
                        try {
                            iframeWindow.postMessage({
                                type: 'FRAME_BYPASS',
                                isTop: true,
                                parent: window
                            }, '*');
                        } catch (e) {
                            console.log('Could not postMessage to iframe:', e);
                        }
                    }
                } catch (e) {
                    console.log('Could not access iframe window (CORS):', e);
                }
            };

            iframe.onerror = function() {
                console.error('Iframe failed to load');
                loading.innerHTML = '<p>Failed to load Metricool. Please try opening it directly.</p>';
            };

            // Listen for messages from the iframe
            window.addEventListener('message', function(event) {
                console.log('Received message from iframe:', event.data);

                // If iframe detects it's in a frame and asks for bypass
                if (event.data && event.data.type === 'FRAME_DETECTED') {
                    console.log('Iframe detected frame, sending bypass response');
                    event.source.postMessage({
                        type: 'FRAME_BYPASS_RESPONSE',
                        isTop: true,
                        bypassFrameDetection: true
                    }, '*');
                }
            });

            // Fallback: show iframe after 3 seconds regardless
            setTimeout(function() {
                loading.classList.add('hidden');
                iframe.classList.remove('hidden');
                console.log('Fallback: showing iframe after timeout');
            }, 3000);
        }
    </script>
</body>
</html>